<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Stable GPS AR Building</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
</head>

<body style="margin: 0; overflow: hidden; background: transparent;">

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="alpha: true"
  >

    <a-assets>
      <a-asset-item id="model" src="img/4ensr.glb"></a-asset-item>
    </a-assets>

    <script>
      // ===========================
      // æºã‚Œã®å°‘ãªã„ GPS AR ãƒ­ã‚¸ãƒƒã‚¯
      // ===========================

      let anchor = null;            // æœ€åˆã® GPS ä½ç½®ï¼ˆåŸºæº–ï¼‰
      const smoothing = 0.1;        // æºã‚Œå¸åä¿‚æ•°ï¼ˆå¤§â†’å®‰å®šï¼‰

      // ç·¯åº¦çµŒåº¦ â†’ ãƒ­ãƒ¼ã‚«ãƒ« ENU åº§æ¨™å¤‰æ›
      function gpsToLocal(lat, lon, base) {
        const R = 6378137;
        const dLat = (lat - base.lat) * Math.PI / 180;
        const dLon = (lon - base.lon) * Math.PI / 180;

        return {
          x: R * dLon * Math.cos(base.lat * Math.PI / 180),
          z: -R * dLat
        };
      }

      AFRAME.registerComponent("stable-gps-object", {
        schema: {
          lat: { type: "number" },
          lon: { type: "number" },
          height: { type: "number", default: 0 }
        },

        init: function () {
          this.targetPos = new THREE.Vector3();

          window.addEventListener("gps-camera-update-position", (e) => {
            const camLat = e.detail.position.latitude;
            const camLon = e.detail.position.longitude;

            // 1å›ã ã‘åŸºæº–ç‚¹ã‚’æ±ºã‚ã‚‹
            if (!anchor) {
              anchor = { lat: camLat, lon: camLon };
              console.log("ğŸ“Œ Anchor fixed:", anchor);
            }

            // å»ºç‰©ã®ãƒ­ãƒ¼ã‚«ãƒ«ä½ç½®è¨ˆç®—
            const local = gpsToLocal(this.data.lat, this.data.lon, anchor);

            this.targetPos.set(local.x, this.data.height, local.z);
          });
        },

        tick: function () {
          // åŸºæº–ç‚¹ãŒã¾ã æ±ºã¾ã£ã¦ã„ãªã„å ´åˆã¯å‹•ã‹ã•ãªã„
          if (!anchor) return;

          // æºã‚Œã‚’å¸åã—ãªãŒã‚‰ä½ç½®æ›´æ–°
          this.el.object3D.position.lerp(this.targetPos, smoothing);
        }
      });
    </script>

    <!-- ========================= -->
    <!-- å»ºç‰©ãƒ¢ãƒ‡ãƒ« -->
    <!-- ========================= -->
    <a-entity stable-gps-object="lat: 33.548324; lon: 133.681047; height: -1;">
      <a-entity gltf-model="#model" scale="1 1 1"></a-entity>
    </a-entity>

    <!-- ========================= -->
    <!-- ã‚«ãƒ¡ãƒ© -->
    <!-- ========================= -->
    <a-camera gps-camera rotation-reader></a-camera>

  </a-scene>
</body>
</html>
