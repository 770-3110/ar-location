<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Stable GPS AR Building</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
</head>

<body style="margin: 0; overflow: hidden; background: transparent;">

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="alpha: true"
  >

    <a-assets>
      <a-asset-item id="model" src="img/4ensr.glb"></a-asset-item>
    </a-assets>

    <!-- ========================= -->
    <!-- å›ºå®šä½ç½® AR ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
    <!-- ========================= -->
    <script>
      let anchorWorld = null;   // æœ€åˆã«æ±ºã‚ã‚‹åŸºæº–åº§æ¨™
      const smoothing = 0.08;   // æºã‚Œ0ã«ã™ã‚‹è£œæ­£å€¤

      // ç·¯åº¦çµŒåº¦ â†’ ENUï¼ˆãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ï¼‰
      function gpsToLocal(lat, lon, base) {
        const R = 6378137;  // åœ°çƒåŠå¾„
        const dLat = (lat - base.lat) * Math.PI / 180;
        const dLon = (lon - base.lon) * Math.PI / 180;

        return {
          x: R * dLon * Math.cos(base.lat * Math.PI / 180),
          z: -R * dLat
        };
      }

      AFRAME.registerComponent("stable-gps-object", {
        schema: {
          lat: {type: "number"},
          lon: {type: "number"},
          height: {type: "number", default: 0}
        },
        init: function () {
          this.targetPos = new THREE.Vector3();
        },
        tick: function () {
          const cam = document.querySelector("[gps-camera]");
          const camDetail = cam.components["gps-camera"];

          // GPS ãŒã¾ã å–å¾—ã§ãã¦ã„ãªã„å ´åˆ
          if (!camDetail.currentCoords) return;

          const camLat = camDetail.currentCoords.latitude;
          const camLon = camDetail.currentCoords.longitude;

          // åŸºæº–ä½ç½®ã‚’1åº¦ã ã‘å›ºå®š
          if (!anchorWorld) {
            anchorWorld = { lat: camLat, lon: camLon };
            console.log("ğŸ“Œ Anchor fixed:", anchorWorld);
          }

          // å»ºç‰©ã®ãƒ­ãƒ¼ã‚«ãƒ«ä½ç½®
          const local = gpsToLocal(this.data.lat, this.data.lon, anchorWorld);

          // æ»‘ã‚‰ã‹ã«å»ºç‰©ã‚’å›ºå®š
          this.targetPos.set(local.x, this.data.height, local.z);
          this.el.object3D.position.lerp(this.targetPos, smoothing);
        }
      });
    </script>

    <!-- ========================= -->
    <!-- å»ºç‰©ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ -->
    <!-- ========================= -->
    <a-entity stable-gps-object="lat: 33.548324; lon: 133.681047; height: -1;">
      <a-entity gltf-model="#model" scale="1 1 1"></a-entity>
    </a-entity>

    <!-- ========================= -->
    <!-- ã‚«ãƒ¡ãƒ© -->
    <!-- ========================= -->
    <a-camera gps-camera rotation-reader></a-camera>

  </a-scene>
</body>
</html>
