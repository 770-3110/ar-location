<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Strict GPS AR Placement</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
</head>

<body style="margin:0; overflow:hidden; background:black;">

<a-scene
  embedded
  vr-mode-ui="enabled:false"
  arjs="sourceType: webcam; debugUIEnabled: true;"
  renderer="alpha:true"
>

  <a-assets>
    <a-asset-item id="model" src="img/4ensr.glb"></a-asset-item>
  </a-assets>

  <!-- ===== Âª∫Áâ©ÔºàÊúÄÂàù„ÅØÈùûË°®Á§∫Ôºâ ===== -->
  <a-entity
    id="building"
    visible="false"
    gps-entity-place="latitude: 33.5484305; longitude: 133.681023;"
  >
    <a-entity
      id="gltf"
      gltf-model="#model"
      scale="1 1 1"
    ></a-entity>
  </a-entity>

  <!-- „Ç´„É°„É© -->
  <a-camera gps-camera rotation-reader></a-camera>

</a-scene>

<script>
/* ===== Ë®≠ÂÆö ===== */
const MAX_DISTANCE = 50; // mÔºà„Åì„Çå‰ª•‰∏äÈÅ†„ÅÑ„Å®Ë°®Á§∫„Åó„Å™„ÅÑÔºâ

/* Ë∑ùÈõ¢Ë®àÁÆó */
function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6378137;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* GPSÂèñÂæóÁ¢∫Ë™ç */
let cameraCoords = null;

window.addEventListener("gps-camera-update-position", e => {
  cameraCoords = e.detail.position;
  console.log("üìç Camera GPS:", cameraCoords);
});

/* GPSË®≠ÁΩÆÂÆå‰∫ÜÊôÇ */
window.addEventListener("gps-entity-place-added", () => {
  if (!cameraCoords) return;

  const targetLat = 33.548324;
  const targetLon = 133.681047;

  const d = calcDistance(
    cameraCoords.latitude,
    cameraCoords.longitude,
    targetLat,
    targetLon
  );

  console.log("üìè Distance to target:", d.toFixed(1), "m");

  const building = document.getElementById("building");

  if (d <= MAX_DISTANCE) {
    building.setAttribute("visible", true);
    console.log("‚úÖ Building visible (GPS OK)");
  } else {
    building.setAttribute("visible", false);
    console.log("‚ùå Too far: building hidden");
  }
});

/* „É¢„Éá„É´ÂéüÁÇπË£úÊ≠£ */
document.getElementById("gltf").addEventListener("model-loaded", e => {
  const model = e.detail.model;
  const box = new THREE.Box3().setFromObject(model);
  const center = box.getCenter(new THREE.Vector3());
  const size = box.getSize(new THREE.Vector3());

  model.position.sub(center);
  model.position.y += size.y / 2; // Ë∂≥ÂÖÉ„ÇíÂú∞Èù¢„Å∏
});
</script>

</body>
</html>
